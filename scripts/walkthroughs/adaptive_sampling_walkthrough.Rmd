---
title: "Adaptive sampling walkthrough"
author: "TMM"
date: "2023-10-24"
output: html_document
---

```{r setup}

library(mgcv)
library(terra)
library(tidyverse)
library(sf)
library(viridis)

```


```{r initial_data}

# environmental data for raster
envdat <- rast('../../data/environmental_data_subset.tif')

# true species distribution
species_distrib_rast <- rast('../../outputs/simulated_data/true_species_distribution.tif')
species_distrib_df <- as.data.frame(species_distrib_rast, xy=TRUE)
colnames(species_distrib_df) <- c("x", "y", "presence")

```


# Introduction

This R notebook accompanies figure XX in the paper 'Adaptive sampling in ecology: current practice and future opportunities'. Here, we aim to demonstrate how adaptive sampling can be used in an ecological setting. For this, we take the case of species distribution models, where we are aiming to improve our knowledge of species' distributions.

This will follow several steps:

0. Generation of initial data
1. Defining a criterion
  1a. Empirical
  1b. Model-based
2. Selection of new sampling occasions
  2a. Optimised
  2b. Independent draws
3. Sampling activity
  - Rounds vs batches


# Adaptive sampling

## Step 0. Generation of initial data

For any adaptive sampling programme, we first need some initial data on which we can base our further sampling. This is code is located in `/scripts/processing/simulate_species.R` and uses some environmental variables to generate the true distribution of a species. We then sample this true species distribution according to the suburban distribution of GB, mimicking real life where people tend to record close to their homes.

```{r load_species_data}

species_records <- read.csv("../../outputs/simulated_data/sampled_species_distrib.csv")[,-1]

# define observations
species_records$observations <- 1

head(species_records)

```

## Step 1. Definition of a criterion

### Step 1a. Empirical criterion

An empirical criterion involves using only the data to determine locations for further sampling. In this case, we will identify regions that have not yet been sampled. In the code below, we convert our species records into a 1km binary raster format for presences (`1`) and absences (`0`). This creates a raster map of the species' distribution which will be our *empirical sampling layer*.


```{r empirical}

# convert species records to raster
species_rast <- rasterize(x = as.matrix(species_records[,1:2]), y = envdat[[1]], 
                          values = 1, background = 0)
species_rast_gb <- mask(species_rast, envdat[["elev"]]) # mask to GB
# Unvisited locations are any 0s!

## visualise
empirical_criterion <- as.data.frame(species_rast_gb, xy = TRUE)
colnames(empirical_criterion) <- c('x', 'y', 'observations')
# head(empirical_df)

ggplot(empirical_criterion, aes(x,y, fill = factor(observations))) +
  geom_tile() +
  scale_fill_manual(name = '', labels = c("No records", "Observation"),
                    values = c("#E69F00", "#009E73")) +
  
  theme_bw()

```


### Step 1b. Model-based criterion

In a model-based adaptive sampling criterion, further sampling is based on some aspect of a model. Here, we will model the species distribution as a function of several environmental variables using GAMs. Then we will use the standard error as our measure of uncertainty on which to base further sampling. 

### Pseudoabsences

A key consideration in SDM of presence-only data is the choice of method to get pseudoabsences. This requires careful thought but here, we choose to use a random background approach as we are not interested in its effect on model performance. We will use the layer above to generate an equal number of pseudoabsences to the number of presences.

```{r pseudoabsences}

# get all locations with no records
no_records <- empirical_criterion[empirical_criterion$observations==0,]

# randomly sample
psedoabs_index <- sample(1:nrow(no_records), size = sum(empirical_criterion$observations==1))

# extract pseudoabsences
pseudoabs <- no_records[psedoabs_index,]

# bind to observations
speciesobs_df <- rbind(species_records, pseudoabs)

# visualise
ggplot(speciesobs_df, aes(x, y, col = factor(observations))) +
  geom_point(size = 0.2) +
  scale_colour_manual(name = '', labels = c("Pseudoabsences", "Presences"),
                      values = c("#E69F00", "#009E73")) +
  
  theme_bw()

```

#### Modelling

Model data and predict for GB

```{r modelling}

## get environmental data for each observation -- extract() from envdat
# choose the variables used to simulate the species and a few others

# extract data
recsdf <- cbind(speciesobs_df, 
                terra::extract(envdat, speciesobs_df[1:2], 
                               xy = FALSE, method = "simple"))
head(recsdf)

# model - simple model with few explanatory variables
gammod <- gam(observations ~ s(impr_grass) +
                s(elev) + 
                s(bio_1),
              family = 'binomial',
              data = recsdf)
summary(gammod)
plot(gammod)

# convert environmental raster to data frame
edatdf <- as.data.frame(envdat[[c("impr_grass", "elev", "bio_1")]],
                        na.rm = TRUE,
                        xy = TRUE)

# create a new x variable
newx <- edatdf[, c("x", "y", "impr_grass", "elev", "bio_1")]

# predict onto environment
newy <- predict(gammod, 
                newx,
                type = "response",
                se.fit = TRUE)

modelbased_criterion <- na.omit(cbind(newx, newy))


```


#### Extracting uncertainty

```{r standard error}

# probability of presences
ggplot(modelbased_criterion, aes(x, y, fill = fit)) +
  geom_tile() +
  scale_fill_viridis_c(name = "Probability of presence") +
  
  theme_bw()

# standard error 
ggplot(modelbased_criterion, aes(x, y, fill = (se.fit))) +
  geom_tile() +
  scale_fill_viridis_c(name = "Standard error") +
  
  theme_bw()


```


## Step 2. Selection of new sampling occasions

Important to choose the number of new locations versus number of batches. We're going to choose 10% of number of observations = 35.

### Step 2a. Optimised

```{r empirical_optimised}

empirical_criterion

```


```{r model-based_optimised}

modelbased_criterion

```


### Step 2b. Independent draws

```{r empirical_independent_draws}

# unvisited areas
emp_criterion_absences <- empirical_criterion[empirical_criterion$observations == 0,]
emp_critind <- sample(1:nrow(emp_criterion_absences), 750) ## how many new locations are visited

# New locations visited
emp_indepdraw_new_locs <- emp_criterion_absences[emp_critind,]

# plot against true distribution
ggplot() +
  geom_tile(data = species_distrib_df, aes(x,y, fill = factor(presence))) +
  geom_point(data = emp_indepdraw_new_locs, aes(x,y, colour = "new visits"), size = 0.5) +
  scale_colour_manual(values = "blue", name = "") +
  scale_fill_manual(name = '', labels = c("Absent", "Present"),
                    values = c("#E69F00", "#009E73")) +
  
  theme_bw()

```


```{r model-based_independent_draws}

modelbased_criterion

```




need to compare against the true species distribution to see whether new observations are made --- Maybe next step because it's not technically part of the adaptive sampling process (Maybe in the rounds vs batches section)

